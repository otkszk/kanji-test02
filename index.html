<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦ç”Ÿ æ¼¢å­—ã‚¯ã‚¤ã‚º</title>
    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (CSS) */
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            background-color: #f0f8ff;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠé˜²æ­¢ */
        }

        .app-container {
            background-color: white;
            width: 90%;
            max-width: 500px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 { color: #2c3e50; font-size: 24px; margin-bottom: 20px; }
        h2 { color: #007bff; font-size: 20px; margin: 10px 0; }

        /* ãƒœã‚¿ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.1s;
        }
        .btn:hover { background-color: #45a049; }
        .btn:active { transform: scale(0.98); }
        
        .btn-large { width: 100%; font-size: 18px; margin: 15px 0; }
        
        .btn-option { 
            background-color: #fff; 
            color: #333; 
            border: 2px solid #ddd; 
            font-weight: bold;
        }
        .btn-option:hover { background-color: #e3f2fd; }

        /* é¸æŠçŠ¶æ…‹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .selected { background-color: #007bff; color: white; border-color: #007bff; }

        /* æ¼¢å­—è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .kanji-display {
            font-size: 80px;
            margin: 10px 0 20px 0;
            font-weight: bold;
            color: #333;
        }

        /* ç”»é¢ã®åˆ‡ã‚Šæ›¿ãˆç”¨ */
        .screen { display: none; }
        .active { display: block; }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .settings-group { margin-bottom: 20px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .settings-label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        
        .grade-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ */
        .timer-container {
            width: 100%;
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px 0;
            height: 10px;
            overflow: hidden;
        }
        .timer-bar {
            height: 100%;
            background-color: #ff9800;
            width: 100%;
            transition: width 0.1s linear;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .feedback {
            font-size: 24px;
            font-weight: bold;
            height: 35px;
            margin-bottom: 5px;
        }
        .correct { color: #d32f2f; }
        .incorrect { color: #1976d2; }

    </style>
</head>
<body>

<div class="app-container">
    <div id="menu-screen" class="screen active">
        <h1>ğŸ« å°å­¦ç”Ÿ æ¼¢å­—ã‚¯ã‚¤ã‚º</h1>
        
        <div class="settings-group">
            <span class="settings-label">â‘  å­¦å¹´ã‚’ãˆã‚‰ã‚“ã§ã­</span>
            <div class="grade-grid" id="grade-selector">
                </div>
        </div>

        <div class="settings-group">
            <span class="settings-label">â‘¡ å•é¡Œæ•°</span>
            <div>
                <button class="btn q-count-btn selected" onclick="selectQuestionCount(5)">5å•</button>
                <button class="btn q-count-btn" onclick="selectQuestionCount(10)">10å•</button>
            </div>
        </div>

        <div class="settings-group">
            <span class="settings-label">â‘¢ åˆ¶é™æ™‚é–“ï¼ˆ1å•ã‚ãŸã‚Šï¼‰</span>
            <div>
                <button class="btn time-limit-btn selected" onclick="selectTimeLimit(5)">5ç§’</button>
                <button class="btn time-limit-btn" onclick="selectTimeLimit(10)">10ç§’</button>
            </div>
        </div>

        <button class="btn btn-large" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="quiz-screen" class="screen">
        <h2 id="progress-text">ç¬¬ 1 å•</h2>
        
        <div class="timer-container">
            <div id="timer-bar" class="timer-bar"></div>
        </div>
        
        <div id="feedback-area" class="feedback"></div>
        <div class="kanji-display" id="kanji-text">æ¼¢</div>
        <div id="options-container">
            </div>
    </div>

    <div id="result-screen" class="screen">
        <h1>çµæœç™ºè¡¨ï¼</h1>
        <p style="font-size: 20px;">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢</p>
        <div class="kanji-display" style="color: #d32f2f;" id="score-text">100ç‚¹</div>
        <p id="comment-text">ã™ã”ã„ï¼</p>
        <button class="btn btn-large" onclick="returnToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹</button>
    </div>
</div>

<script>
    /* --- ãƒ‡ãƒ¼ã‚¿è¨­å®š (ã‚µãƒ³ãƒ—ãƒ«) --- */
    const kanjiDatabase = {
        1: [
            { kanji: "é›¨", reading: "ã‚ã‚" }, { kanji: "ç‹", reading: "ãŠã†" }, 
            { kanji: "éŸ³", reading: "ãŠã¨" }, { kanji: "ä¸‹", reading: "ã—ãŸ" },
            { kanji: "ç«", reading: "ã²" }, { kanji: "èŠ±", reading: "ã¯ãª" },
            { kanji: "è²", reading: "ã‹ã„" }, { kanji: "å­¦", reading: "ãŒã" },
            { kanji: "æ°—", reading: "ã" }, { kanji: "ä¹", reading: "ãã‚…ã†" },
            { kanji: "ä¼‘", reading: "ã‚„ã™ã¿" }, { kanji: "ç‰", reading: "ãŸã¾" }
        ],
        2: [
            { kanji: "å¼•", reading: "ã²ã" }, { kanji: "é›²", reading: "ãã‚‚" },
            { kanji: "åœ’", reading: "ãã®" }, { kanji: "é ", reading: "ã¨ãŠã„" },
            { kanji: "ä½•", reading: "ãªã«" }, { kanji: "å¤", reading: "ãªã¤" },
            { kanji: "å®¶", reading: "ã„ãˆ" }, { kanji: "ç§‘", reading: "ã‹" },
            { kanji: "æ­Œ", reading: "ã†ãŸ" }, { kanji: "ç”»", reading: "ãŒ" }
        ],
        3: [
            { kanji: "æ‚ª", reading: "ã‚ã‚‹ã„" }, { kanji: "å®‰", reading: "ã‚„ã™ã„" },
            { kanji: "åŒ»", reading: "ã„" }, { kanji: "å§”", reading: "ã„" },
            { kanji: "æ„", reading: "ã„" }, { kanji: "è‚²", reading: "ãã ã¤" },
            { kanji: "å“¡", reading: "ã„ã‚“" }, { kanji: "é£²", reading: "ã®ã‚€" },
            { kanji: "é™¢", reading: "ã„ã‚“" }, { kanji: "é‹", reading: "ã¯ã“ã¶" }
        ],
        4: [
            { kanji: "æ„›", reading: "ã‚ã„" }, { kanji: "æ¡ˆ", reading: "ã‚ã‚“" },
            { kanji: "ä»¥", reading: "ã„" }, { kanji: "è¡£", reading: "ã“ã‚ã‚‚" },
            { kanji: "ä½", reading: "ãã‚‰ã„" }, { kanji: "å›²", reading: "ã‹ã“ã‚€" },
            { kanji: "èƒƒ", reading: "ã„" }, { kanji: "å°", reading: "ã—ã‚‹ã—" },
            { kanji: "è‹±", reading: "ãˆã„" }, { kanji: "æ „", reading: "ã•ã‹ãˆ" }
        ],
        5: [
            { kanji: "åœ§", reading: "ã‚ã¤" }, { kanji: "ç§»", reading: "ã†ã¤ã‚‹" },
            { kanji: "å› ", reading: "ã‚ˆã‚‹" }, { kanji: "æ°¸", reading: "ãªãŒã„" },
            { kanji: "å–¶", reading: "ã„ã¨ãªã‚€" }, { kanji: "è¡›", reading: "ãˆã„" },
            { kanji: "æ˜“", reading: "ã‚„ã•ã—ã„" }, { kanji: "ç›Š", reading: "ãˆã" },
            { kanji: "æ¶²", reading: "ãˆã" }, { kanji: "æ¼”", reading: "ãˆã‚“" }
        ],
        6: [
            { kanji: "ç•°", reading: "ã“ã¨" }, { kanji: "éº", reading: "ã„" },
            { kanji: "åŸŸ", reading: "ã„ã" }, { kanji: "å®‡", reading: "ã†" },
            { kanji: "æ˜ ", reading: "ã†ã¤ã‚‹" }, { kanji: "å»¶", reading: "ã®ã³ã‚‹" },
            { kanji: "æ²¿", reading: "ãã†" }, { kanji: "æˆ‘", reading: "ã‚ã‚Œ" },
            { kanji: "ç°", reading: "ã¯ã„" }, { kanji: "æ‹¡", reading: "ã‹ã" }
        ]
    };

    /* --- åŠ¹æœéŸ³ã®èª­ã¿è¾¼ã¿ --- */
    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã€try-catchã‚’å…¥ã‚Œã¦ã„ã¾ã™ãŒã€
    // åŸºæœ¬çš„ã«ã¯ sounds/correct.mp3 ãªã©ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ã€‚
    const audioCorrect = new Audio('sounds/correct.mp3');
    const audioWrong = new Audio('sounds/wrong.mp3');

    function playSound(isCorrect) {
        // éŸ³å£°ã‚’æœ€åˆã‹ã‚‰å†ç”Ÿ
        const audio = isCorrect ? audioCorrect : audioWrong;
        audio.currentTime = 0; 
        audio.play().catch(e => console.log("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + e));
    }

    /* --- çŠ¶æ…‹ç®¡ç† --- */
    let selectedGrade = 1;
    let questionCount = 5;
    let timeLimit = 5; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5ç§’
    let quizList = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let isAnswering = false;
    let timerInterval = null;
    let timeLeft = 0;

    /* --- åˆæœŸåŒ– --- */
    window.onload = function() {
        const gradeSelector = document.getElementById('grade-selector');
        for (let i = 1; i <= 6; i++) {
            let btn = document.createElement('button');
            btn.className = `btn btn-option ${i === 1 ? 'selected' : ''}`;
            btn.innerText = `${i}å¹´`;
            btn.onclick = () => selectGrade(i, btn);
            gradeSelector.appendChild(btn);
        }
    };

    /* --- è¨­å®šæ“ä½œ --- */
    function selectGrade(grade, btnElement) {
        selectedGrade = grade;
        document.querySelectorAll('#grade-selector .btn').forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');
    }

    function selectQuestionCount(count) {
        questionCount = count;
        updateButtonSelection('.q-count-btn', count);
    }

    function selectTimeLimit(seconds) {
        timeLimit = seconds;
        updateButtonSelection('.time-limit-btn', seconds);
    }

    function updateButtonSelection(selector, value) {
        document.querySelectorAll(selector).forEach(b => {
            if(b.innerText.includes(value)) b.classList.add('selected');
            else b.classList.remove('selected');
        });
    }

    /* --- ã‚²ãƒ¼ãƒ é–‹å§‹ --- */
    function startGame() {
        const sourceData = kanjiDatabase[selectedGrade];
        if (!sourceData || sourceData.length < 3) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        let shuffled = [...sourceData].sort(() => 0.5 - Math.random());
        quizList = shuffled.slice(0, Math.min(questionCount, sourceData.length));
        
        currentQuestionIndex = 0;
        score = 0;

        showScreen('quiz-screen');
        loadQuestion();
    }

    /* --- å•é¡Œèª­ã¿è¾¼ã¿ --- */
    function loadQuestion() {
        isAnswering = false;
        clearInterval(timerInterval); // å‰ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢

        document.getElementById('feedback-area').innerText = "";
        document.getElementById('progress-text').innerText = `ç¬¬ ${currentQuestionIndex + 1} å• / ${quizList.length} å•`;

        const currentData = quizList[currentQuestionIndex];
        document.getElementById('kanji-text').innerText = currentData.kanji;

        // é¸æŠè‚¢ç”Ÿæˆ
        let options = [currentData.reading];
        const otherReadings = kanjiDatabase[selectedGrade]
            .filter(item => item.reading !== currentData.reading)
            .map(item => item.reading);
        
        let wrongAnswers = otherReadings.sort(() => 0.5 - Math.random()).slice(0, 2);
        options = options.concat(wrongAnswers);
        options.sort(() => 0.5 - Math.random());

        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = "";
        
        options.forEach(option => {
            let btn = document.createElement('button');
            btn.className = "btn btn-large btn-option";
            btn.innerText = option;
            btn.onclick = () => checkAnswer(option, currentData.reading);
            optionsContainer.appendChild(btn);
        });

        // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ
        startTimer();
    }

    /* --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ --- */
    function startTimer() {
        timeLeft = timeLimit;
        const timerBar = document.getElementById('timer-bar');
        timerBar.style.width = "100%";
        timerBar.style.backgroundColor = "#ff9800";

        // 0.1ç§’ã”ã¨ã«æ›´æ–°
        timerInterval = setInterval(() => {
            timeLeft -= 0.1;
            // ãƒãƒ¼ã®é•·ã•ã‚’æ›´æ–°
            let percentage = (timeLeft / timeLimit) * 100;
            timerBar.style.width = `${percentage}%`;

            // æ®‹ã‚Šæ™‚é–“ãŒå°‘ãªããªã£ãŸã‚‰èµ¤ãã™ã‚‹
            if (percentage < 30) {
                timerBar.style.backgroundColor = "#d32f2f";
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timeUp();
            }
        }, 100);
    }

    function timeUp() {
        if(isAnswering) return;
        const currentData = quizList[currentQuestionIndex];
        // æ™‚é–“åˆ‡ã‚Œã¯å¼·åˆ¶çš„ã«ä¸æ­£è§£æ‰±ã„
        showFeedback(false, currentData.reading, true);
    }

    /* --- ç­”ãˆåˆã‚ã› --- */
    function checkAnswer(selected, correct) {
        if (isAnswering) return;
        clearInterval(timerInterval); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        
        const isCorrect = (selected === correct);
        if (isCorrect) score++;
        
        showFeedback(isCorrect, correct, false);
    }

    function showFeedback(isCorrect, correctAns, isTimeUp) {
        isAnswering = true;
        const feedback = document.getElementById('feedback-area');
        
        if (isCorrect) {
            feedback.innerText = "æ­£è§£ï¼â­•";
            feedback.className = "feedback correct";
            playSound(true);
        } else {
            playSound(false);
            feedback.className = "feedback incorrect";
            if (isTimeUp) {
                feedback.innerText = `æ™‚é–“åˆ‡ã‚Œ... æ­£è§£ã¯ã€Œ${correctAns}ã€`;
            } else {
                feedback.innerText = `æ®‹å¿µ... æ­£è§£ã¯ã€Œ${correctAns}ã€`;
            }
        }

        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizList.length) {
                loadQuestion();
            } else {
                showResult();
            }
        }, 2000); // çµæœè¡¨ç¤ºæ™‚é–“ã‚’å°‘ã—é•·ã‚ã«ï¼ˆéŸ³ã‚’èããŸã‚ï¼‰
    }

    /* --- çµæœç”»é¢ --- */
    function showResult() {
        showScreen('result-screen');
        const scoreText = document.getElementById('score-text');
        const commentText = document.getElementById('comment-text');
        
        const percentage = Math.round((score / quizList.length) * 100);
        scoreText.innerText = `${percentage}ç‚¹`;

        if (percentage === 100) {
            commentText.innerText = "å¤§å¤‰ã‚ˆãã§ãã¾ã—ãŸï¼ğŸ’®";
            playSound(true);
        } else if (percentage >= 80) {
            commentText.innerText = "ã‚ã¨å°‘ã—ï¼ãŠã—ã„ï¼ğŸ‘";
        } else {
            commentText.innerText = "ã¾ãŸãŒã‚“ã°ã‚ã†ï¼ğŸ’ª";
        }
    }

    function returnToMenu() {
        showScreen('menu-screen');
    }

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }
</script>

</body>
</html>
